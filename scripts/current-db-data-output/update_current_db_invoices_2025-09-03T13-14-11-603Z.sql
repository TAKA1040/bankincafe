-- 現在のDBにある請求書の不足データを更新するSQL
-- 作成日: 2025-09-03T13:14:11.605Z
-- 対象件数: 50 件

-- =====================================
-- 1. 不足フィールドを追加（存在しない場合のみ）
-- =====================================
ALTER TABLE invoices 
ADD COLUMN IF NOT EXISTS invoice_number TEXT,
ADD COLUMN IF NOT EXISTS billing_date DATE,
ADD COLUMN IF NOT EXISTS customer_name TEXT;

-- =====================================
-- 2. 現在のDBにある請求書データを更新
-- =====================================

UPDATE invoices SET 
  invoice_number = supplement.invoice_number,
  billing_date = supplement.billing_date::DATE,
  customer_name = supplement.customer_name
FROM (VALUES
  ('25043369-1', '25043369-1', '2025-04-24', 'UDトラックス株式会社'),\n  ('25043370-1', '25043370-1', '2025-04-24', 'UDトラックス株式会社'),\n  ('25043370-2', '25043370-2', '2025-04-24', 'UDトラックス株式会社'),\n  ('25043371-1', '25043371-1', '2025-04-27', 'UDトラックス株式会社'),\n  ('25043372-1', '25043372-1', '2025-04-27', 'UDトラックス株式会社'),\n  ('25043373-1', '25043373-1', '2025-04-27', 'UDトラックス株式会社'),\n  ('25043374-1', '25043374-1', '2025-04-27', 'UDトラックス株式会社'),\n  ('25043375-1', '25043375-1', '2025-04-27', 'UDトラックス株式会社'),\n  ('25043376-1', '25043376-1', '2025-04-27', 'UDトラックス株式会社'),\n  ('25043377-1', '25043377-1', '2025-04-27', 'UDトラックス株式会社'),\n  ('25043378-1', '25043378-1', '2025-04-28', 'UDトラックス株式会社'),\n  ('25043379-1', '25043379-1', '2025-04-30', 'UDトラックス株式会社'),\n  ('25043380-1', '25043380-1', '2025-04-30', 'UDトラックス株式会社'),\n  ('25043385-1', '25043385-1', '2025-05-12', 'UDトラックス株式会社'),\n  ('25043385-2', '25043385-2', '2025-05-12', 'UDトラックス株式会社'),\n  ('25053381-1', '25053381-1', '2025-05-01', 'UDトラックス株式会社'),\n  ('25053382-1', '25053382-1', '2025-05-02', 'UDトラックス株式会社'),\n  ('25053383-1', '25053383-1', '2025-05-08', 'UDトラックス株式会社'),\n  ('25053384-1', '25053384-1', '2025-05-08', 'UDトラックス株式会社'),\n  ('25053386-1', '25053386-1', '2025-05-12', 'UDトラックス株式会社'),\n  ('25053387-1', '25053387-1', '2025-05-15', 'UDトラックス株式会社'),\n  ('25053388-1', '25053388-1', '2025-05-15', 'UDトラックス株式会社'),\n  ('25053389-1', '25053389-1', '2025-05-15', 'UDトラックス株式会社'),\n  ('25053390-1', '25053390-1', '2025-05-18', 'UDトラックス株式会社'),\n  ('25053391-1', '25053391-1', '2025-05-18', 'UDトラックス株式会社'),\n  ('25053392-1', '25053392-1', '2025-05-18', 'UDトラックス株式会社'),\n  ('25053393-1', '25053393-1', '2025-05-18', 'UDトラックス株式会社'),\n  ('25053394-1', '25053394-1', '2025-05-18', 'UDトラックス株式会社'),\n  ('25053395-1', '25053395-1', '2025-05-18', 'UDトラックス株式会社'),\n  ('25053396-1', '25053396-1', '2025-05-19', 'UDトラックス株式会社'),\n  ('25053397-1', '25053397-1', '2025-05-20', 'UDトラックス株式会社'),\n  ('25053398-1', '25053398-1', '2025-05-20', 'UDトラックス株式会社'),\n  ('25053399-1', '25053399-1', '2025-05-21', 'UDトラックス株式会社'),\n  ('25053400-1', '25053400-1', '2025-05-21', 'UDトラックス株式会社'),\n  ('25053401-1', '25053401-1', '2025-05-25', 'UDトラックス株式会社'),\n  ('25053401-2', '25053401-2', '2025-05-25', 'UDトラックス株式会社'),\n  ('25053402-1', '25053402-1', '2025-05-25', 'UDトラックス株式会社'),\n  ('25053403-1', '25053403-1', '2025-05-25', 'UDトラックス株式会社'),\n  ('25053404-1', '25053404-1', '2025-05-25', 'UDトラックス株式会社'),\n  ('25053405-1', '25053405-1', '2025-05-25', 'UDトラックス株式会社'),\n  ('25053406-1', '25053406-1', '2025-05-25', 'UDトラックス株式会社'),\n  ('25053407-1', '25053407-1', '2025-05-26', 'UDトラックス株式会社'),\n  ('25053408-1', '25053408-1', '2025-05-26', 'UDトラックス株式会社'),\n  ('25053409-1', '25053409-1', '2025-05-26', 'UDトラックス株式会社'),\n  ('25053410-1', '25053410-1', '2025-05-27', 'UDトラックス株式会社'),\n  ('25053411-1', '25053411-1', '2025-05-27', 'UDトラックス株式会社'),\n  ('25053412-1', '25053412-1', '2025-05-28', 'UDトラックス株式会社'),\n  ('25053413-1', '25053413-1', '2025-05-29', 'UDトラックス株式会社'),\n  ('25053414-1', '25053414-1', '2025-05-29', 'UDトラックス株式会社'),\n  ('25053415-1', '25053415-1', '2025-05-29', 'UDトラックス株式会社')\n) AS supplement(invoice_id, invoice_number, billing_date, customer_name)\nWHERE invoices.invoice_id = supplement.invoice_id;\n\n-- =====================================
-- 3. インデックス追加
-- =====================================
CREATE INDEX IF NOT EXISTS idx_invoices_invoice_number ON invoices(invoice_number);
CREATE INDEX IF NOT EXISTS idx_invoices_billing_date ON invoices(billing_date);
CREATE INDEX IF NOT EXISTS idx_invoices_customer_name ON invoices(customer_name);

-- =====================================
-- 4. データ検証
-- =====================================
SELECT 
  COUNT(*) as total_invoices,
  COUNT(invoice_number) as has_invoice_number,
  COUNT(billing_date) as has_billing_date,
  COUNT(customer_name) as has_customer_name,
  COUNT(CASE WHEN invoice_number IS NOT NULL AND billing_date IS NOT NULL AND customer_name IS NOT NULL THEN 1 END) as complete_data
FROM invoices;

-- 更新された請求書の確認
SELECT 
  invoice_id,
  invoice_number,
  billing_date,
  customer_name,
  issue_date
FROM invoices 
WHERE invoice_number IS NOT NULL
ORDER BY invoice_id;

-- 完了メッセージ
SELECT '✅ 現在のDBにある請求書の不足データ更新完了: 50 件' as result;
