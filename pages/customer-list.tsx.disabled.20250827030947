import { useState, useEffect, useCallback } from 'react'
import { useRouter } from 'next/router'
import { Button } from '../components/ui/Button'
import { Input } from '../components/ui/Input'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'

interface Customer {
  id: string
  companyName: string
  personInCharge: string
  position: string
  phone: string
  email: string
  address?: string
  taxNumber?: string
  notes?: string
  createdAt: string
  updatedAt: string
}

const sampleCustomers: Customer[] = [
  {
    id: '1',
    companyName: 'æ ªå¼ä¼šç¤¾UDãƒˆãƒ©ãƒƒã‚¯ã‚¹',
    personInCharge: 'å±±ç”°å¤ªéƒ',
    position: 'éƒ¨é•·',
    phone: '03-1234-5678',
    email: 'yamada@udtrucks.com',
    address: 'æ±äº¬éƒ½å“å·åŒºå—å¤§äº•6-26-2',
    taxNumber: 'T1234567890123',
    notes: 'ä¸»è¦å–å¼•å…ˆã€‚æœˆé–“30-50å°ã®ä¿®ç†ä¾é ¼ã€‚',
    createdAt: '2024-01-01T00:00:00Z',
    updatedAt: '2024-01-15T10:30:00Z'
  },
  {
    id: '2',
    companyName: 'ç”°ä¸­è‡ªå‹•è»Š',
    personInCharge: 'ç”°ä¸­èŠ±å­',
    position: 'ä»£è¡¨å–ç· å½¹',
    phone: '03-9876-5432',
    email: 'tanaka@tanaka-auto.com',
    address: 'æ±äº¬éƒ½è¶³ç«‹åŒºè¥¿æ–°äº•5-7-8',
    taxNumber: 'T9876543210987',
    notes: 'å€‹äººçµŒå–¶ã€‚ãƒãƒ³ãƒ‘ãƒ¼ä¿®ç†ãŒå¤šã„ã€‚',
    createdAt: '2024-01-05T00:00:00Z',
    updatedAt: '2024-01-20T14:15:00Z'
  },
  {
    id: '3',
    companyName: 'ä½è—¤é‹é€æ ªå¼ä¼šç¤¾',
    personInCharge: 'ä½è—¤æ¬¡éƒ',
    position: 'æ•´å‚™èª²é•·',
    phone: '03-5555-1111',
    email: 'sato@sato-unsou.com',
    address: 'æ±äº¬éƒ½ç·´é¦¬åŒºå¤§æ³‰å­¦åœ’ç”º2-3-4',
    taxNumber: 'T1111222233334',
    notes: 'å¤§å‹ãƒˆãƒ©ãƒƒã‚¯ä¸­å¿ƒã€‚å®šæœŸç‚¹æ¤œå¥‘ç´„ã‚ã‚Šã€‚',
    createdAt: '2024-01-10T00:00:00Z',
    updatedAt: '2024-01-25T16:45:00Z'
  },
  {
    id: '4',
    companyName: 'éˆ´æœ¨å•†äº‹',
    personInCharge: 'éˆ´æœ¨ä¸‰éƒ',
    position: 'ç·å‹™éƒ¨é•·',
    phone: '03-7777-8888',
    email: 'suzuki@suzuki-trading.com',
    address: 'æ±äº¬éƒ½æ±Ÿæˆ¸å·åŒºå¹³äº•1-2-3',
    taxNumber: 'T4444555566667',
    notes: 'ä¸­å‹è»Šä¸¡ã®ä¿®ç†å¤šã‚ã€‚æ”¯æ‰•ã„ã‚µã‚¤ãƒˆã¯æœˆæœ«ç· ã‚ç¿Œæœˆæœ«æ‰•ã„ã€‚',
    createdAt: '2024-01-12T00:00:00Z',
    updatedAt: '2024-01-28T09:20:00Z'
  }
]

export default function CustomerListPage() {
  const router = useRouter()
  const [customers, setCustomers] = useState<Customer[]>([])
  const [filteredCustomers, setFilteredCustomers] = useState<Customer[]>([])
  const [loading, setLoading] = useState(true)
  const [searchQuery, setSearchQuery] = useState('')
  const [selectedCustomer, setSelectedCustomer] = useState<Customer | null>(null)

  const loadCustomers = async () => {
    try {
      await new Promise(resolve => setTimeout(resolve, 1000))
      setCustomers(sampleCustomers)
    } catch (error) {
      console.error('Failed to load customers:', error)
    } finally {
      setLoading(false)
    }
  }

  const filterCustomers = useCallback(() => {
    let filtered = [...customers]

    if (searchQuery) {
      filtered = filtered.filter(customer =>
        customer.companyName.toLowerCase().includes(searchQuery.toLowerCase()) ||
        customer.personInCharge.toLowerCase().includes(searchQuery.toLowerCase()) ||
        customer.phone.includes(searchQuery) ||
        customer.email.toLowerCase().includes(searchQuery.toLowerCase()) ||
        customer.position.toLowerCase().includes(searchQuery.toLowerCase())
      )
    }

    filtered.sort((a, b) => a.companyName.localeCompare(b.companyName, 'ja'))

    setFilteredCustomers(filtered)
  }, [customers, searchQuery])

  useEffect(() => {
    loadCustomers()
  }, [])

  useEffect(() => {
    filterCustomers()
  }, [filterCustomers])

  const handleDelete = async (customerId: string) => {
    if (!confirm('ã“ã®é¡§å®¢ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
      return
    }

    try {
      await new Promise(resolve => setTimeout(resolve, 500))
      setCustomers(prev => prev.filter(customer => customer.id !== customerId))
      alert('é¡§å®¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ')
    } catch (error) {
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ')
    }
  }

  const handleViewDetail = (customer: Customer) => {
    setSelectedCustomer(customer)
  }

  const clearFilters = () => {
    setSearchQuery('')
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50">
        <div className="container py-8">
          <div className="flex justify-center items-center h-64">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span className="ml-2 text-lg text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</span>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="container py-6">
        {/* Header */}
        <div className="flex justify-between items-center mb-6">
          <div>
            <h1 className="text-3xl font-bold text-gray-900">ğŸ‘¥ é¡§å®¢ç®¡ç†</h1>
            <p className="text-gray-600 mt-1">é¡§å®¢æƒ…å ±ã®ç™»éŒ²ãƒ»ç®¡ç†ãƒ»å±¥æ­´</p>
          </div>
          <div className="flex gap-2">
            <Button
              variant="secondary"
              onClick={() => router.push('/')}
            >
              â† æˆ»ã‚‹
            </Button>
            <Button
              variant="primary"
              onClick={() => router.push('/customer-create')}
            >
              + æ–°è¦ç™»éŒ²
            </Button>
          </div>
        </div>

        {/* Statistics */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <Card>
            <CardContent>
              <div className="text-center py-4">
                <div className="text-2xl font-bold text-blue-600">{filteredCustomers.length}</div>
                <div className="text-sm text-gray-600">ç™»éŒ²é¡§å®¢æ•°</div>
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardContent>
              <div className="text-center py-4">
                <div className="text-2xl font-bold text-green-600">
                  {customers.filter(c => c.companyName.includes('æ ªå¼ä¼šç¤¾') || c.companyName.includes('æœ‰é™ä¼šç¤¾')).length}
                </div>
                <div className="text-sm text-gray-600">æ³•äººé¡§å®¢</div>
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardContent>
              <div className="text-center py-4">
                <div className="text-2xl font-bold text-yellow-600">
                  {customers.filter(c => c.companyName.includes('UD')).length}
                </div>
                <div className="text-sm text-gray-600">UDç³»é¡§å®¢</div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Search and Filters */}
        <Card className="mb-6">
          <CardHeader>
            <CardTitle className="flex items-center">
              ğŸ” æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Input
                placeholder="ä¼šç¤¾åã€æ‹…å½“è€…åã€é›»è©±ç•ªå·ã€ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
              />
              <Button
                variant="secondary"
                onClick={clearFilters}
              >
                ğŸ—‘ï¸ æ¤œç´¢ã‚¯ãƒªã‚¢
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Customer List */}
        {filteredCustomers.length === 0 ? (
          <Card>
            <CardContent>
              <div className="text-center py-12">
                <div className="text-4xl mb-4">ğŸ‘¥</div>
                <p className="text-gray-600">
                  {searchQuery
                    ? 'æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
                    : 'é¡§å®¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“'}
                </p>
              </div>
            </CardContent>
          </Card>
        ) : (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {filteredCustomers.map((customer) => (
              <Card key={customer.id} className="hover:shadow-md transition-shadow">
                <CardContent>
                  <div className="space-y-4 p-4">
                    {/* Company Info */}
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <h3 className="text-lg font-semibold text-gray-900 mb-2">
                          {customer.companyName}
                        </h3>
                        <div className="flex items-center text-sm text-gray-600 mb-2">
                          <span>{customer.personInCharge}</span>
                          <span className="ml-2 px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">
                            {customer.position}
                          </span>
                        </div>
                      </div>
                    </div>

                    {/* Contact Info */}
                    <div className="space-y-2">
                      <div className="flex items-center text-sm text-gray-600">
                        ğŸ“ <span className="ml-2">{customer.phone}</span>
                      </div>
                      <div className="flex items-center text-sm text-gray-600">
                        âœ‰ï¸ <span className="ml-2 truncate">{customer.email}</span>
                      </div>
                    </div>

                    {/* Address */}
                    {customer.address && (
                      <div className="text-sm text-gray-600">
                        <div className="font-medium">ä½æ‰€</div>
                        <div>{customer.address}</div>
                      </div>
                    )}

                    {/* Tax Number */}
                    {customer.taxNumber && (
                      <div className="text-sm text-gray-600">
                        <span className="font-medium">æ³•äººç•ªå·: </span>
                        <span>{customer.taxNumber}</span>
                      </div>
                    )}

                    {/* Notes */}
                    {customer.notes && (
                      <div className="text-sm text-gray-600">
                        <div className="font-medium">å‚™è€ƒ</div>
                        <div className="text-xs bg-gray-50 p-2 rounded">{customer.notes}</div>
                      </div>
                    )}

                    {/* Actions */}
                    <div className="flex items-center justify-between pt-4 border-t border-gray-200">
                      <div className="text-xs text-gray-500">
                        ç™»éŒ²æ—¥: {new Date(customer.createdAt).toLocaleDateString('ja-JP')}
                      </div>
                      <div className="flex items-center space-x-2">
                        <Button
                          variant="secondary"
                          size="sm"
                          onClick={() => handleViewDetail(customer)}
                        >
                          ğŸ‘ï¸ è©³ç´°
                        </Button>
                        <Button
                          variant="secondary"
                          size="sm"
                          onClick={() => router.push(`/customer-create?edit=${customer.id}`)}
                        >
                          âœï¸ ç·¨é›†
                        </Button>
                        <Button
                          variant="danger"
                          size="sm"
                          onClick={() => handleDelete(customer.id)}
                        >
                          ğŸ—‘ï¸ å‰Šé™¤
                        </Button>
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        )}

        {/* Detail Modal */}
        {selectedCustomer && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-auto">
              <h3 className="text-xl font-bold text-gray-900 mb-4">
                é¡§å®¢è©³ç´° - {selectedCustomer.companyName}
              </h3>
              
              <div className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <div className="text-sm font-medium text-gray-700">ä¼šç¤¾å</div>
                    <div className="text-gray-900">{selectedCustomer.companyName}</div>
                  </div>
                  <div>
                    <div className="text-sm font-medium text-gray-700">æ‹…å½“è€…</div>
                    <div className="text-gray-900">{selectedCustomer.personInCharge}</div>
                  </div>
                  <div>
                    <div className="text-sm font-medium text-gray-700">å½¹è·</div>
                    <div className="text-gray-900">{selectedCustomer.position}</div>
                  </div>
                  <div>
                    <div className="text-sm font-medium text-gray-700">é›»è©±ç•ªå·</div>
                    <div className="text-gray-900">{selectedCustomer.phone}</div>
                  </div>
                  <div className="md:col-span-2">
                    <div className="text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</div>
                    <div className="text-gray-900">{selectedCustomer.email}</div>
                  </div>
                  {selectedCustomer.address && (
                    <div className="md:col-span-2">
                      <div className="text-sm font-medium text-gray-700">ä½æ‰€</div>
                      <div className="text-gray-900">{selectedCustomer.address}</div>
                    </div>
                  )}
                  {selectedCustomer.taxNumber && (
                    <div className="md:col-span-2">
                      <div className="text-sm font-medium text-gray-700">æ³•äººç•ªå·</div>
                      <div className="text-gray-900">{selectedCustomer.taxNumber}</div>
                    </div>
                  )}
                  {selectedCustomer.notes && (
                    <div className="md:col-span-2">
                      <div className="text-sm font-medium text-gray-700">å‚™è€ƒ</div>
                      <div className="text-gray-900 bg-gray-50 p-3 rounded">{selectedCustomer.notes}</div>
                    </div>
                  )}
                </div>
                
                <div className="border-t pt-4">
                  <div className="text-xs text-gray-500">
                    <div>ä½œæˆæ—¥: {new Date(selectedCustomer.createdAt).toLocaleString('ja-JP')}</div>
                    <div>æ›´æ–°æ—¥: {new Date(selectedCustomer.updatedAt).toLocaleString('ja-JP')}</div>
                  </div>
                </div>
              </div>
              
              <div className="flex justify-end gap-2 mt-6">
                <Button
                  variant="secondary"
                  onClick={() => router.push(`/customer-create?edit=${selectedCustomer.id}`)}
                >
                  âœï¸ ç·¨é›†
                </Button>
                <Button
                  variant="secondary"
                  onClick={() => setSelectedCustomer(null)}
                >
                  é–‰ã˜ã‚‹
                </Button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}