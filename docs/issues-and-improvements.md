# 請求書システム - 課題と改善事項

## 🚨 重要課題

### 1. 金額データ不備問題（優先度：高）

**現状**:
- 多数の請求書で金額が正しく表示されない
- 詳細モーダルで「金額データ不備」表示が頻出
- 分割データの多くが `is_cancelled: true` かつ `amount: 0`

**原因**:
- データベース移行時の問題
- 元請求書データの金額情報欠損
- キャンセル処理の誤適用

**影響**:
- 請求書詳細機能が実用的でない
- 経理業務での信頼性低下

**対応策候補**:
1. **データ修復**: 元CSVファイルと照合してデータベース修正
2. **代替データソース**: 他のテーブルから金額情報を取得
3. **手動補正**: 重要な請求書から順次データ修正
4. **システム改修**: 金額計算ロジックの見直し

---

## 📋 その他の課題

### 2. データベース構造の整合性
- `invoice_line_items` テーブルの `amount`, `unit_price` が多数0
- `invoice_line_items_split` テーブルとの関連性に問題

### 3. パフォーマンス
- 詳細モーダル表示時の複数クエリ実行
- 大量データ処理の最適化が必要

---

## ✅ 完了事項

### 1. ハイブリッドページ構成 ✅
- メインページ: 作業項目軸の一覧表示
- 詳細モーダル: 請求書全体表示
- 作業項目から請求書データへの適切な連携

### 2. UI/UX改善 ✅
- 正しい列構成（件名→請求月→登録番号→作業名→対象→種別→単価→詳細）
- 統計表示（総作業数、平均単価、合計金額）
- データ不備時のフォールバック表示

### 3. エラーハンドリング ✅
- データ不備時の適切なメッセージ表示
- 視覚的な区別（正常データは緑、問題データは黄色）

---

## 🔄 次回作業時の優先順位

1. **金額データ修復**（最優先）
2. データベースクエリの最適化
3. 追加機能の実装（検索機能強化など）

---

*記録日: 2025-09-05*  
*記録者: Claude Code*