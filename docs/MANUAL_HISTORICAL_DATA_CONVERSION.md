# 過去データ分解・関連設定作成マニュアル

## 概要
過去の請求書データから作業項目を分解し、新システムの辞書データに変換して関連設定を自動生成するプロセス。

## 全体の流れ

### 1. 目的
- **変換前**: 「左前ドア鈑金修理（バンパー調整含む）¥25,000」（長い文字列）
- **変換後**: 構造化された「対象・動作・位置・メモ・単価」データ
- **最終目標**: 実績ベースの完全な関連設定（target_actions, action_positions）

### 2. 個別/セット判別ルール
- **個別**: 1つの明細 → 1つの「対象・動作・位置・メモ・単価」
- **セット**: 1つの明細 → 複数の「対象・動作・位置・メモ」（セット名に元明細、単価はセット全体）

### 3. セット処理の詳細
- **セット名**: 元の請求書明細文をそのまま使用（既発行請求書との整合性確保）
- **単価配分**: セット全体の単価、詳細項目は単価なし
- **詳細データ**: 分解した各作業を個別に構造化

## 段階的改善方式

### フロー
```
過去データ → 分解処理 → 成功データ（DB登録）
                    ↓
              未処理データ（ファイル保存）
                    ↓
            パターン分析・ルール追加
                    ↓
              再処理（繰り返し）
                    ↓
            最終少数データ（手動処理）
```

### 各段階の詳細

#### Stage 1: 初回分解処理
- **入力**: 過去の請求書明細データ
- **処理**: 基本的なパターンマッチング分解
- **出力**: 
  - 成功データ → データベース登録
  - 未処理データ → JSON/CSVファイル保存
  - 処理ログ → 判断困難な理由を記録

#### Stage 2: 未処理データ分析
- **分析対象**: 前段階で処理できなかった明細
- **作業**: 
  - 共通パターンの発見
  - 新しい判断ルール/正規表現の作成
  - 辞書データ（対象・動作・位置）の追加

#### Stage 3: ルール追加・再処理
- **新ルール適用**: 追加したルールで未処理データを再実行
- **結果**: 処理できたデータを正常データに移行
- **継続**: 未処理データが十分少なくなるまで繰り返し

#### Stage 4: 最終手動処理
- **条件**: 未処理データが数十件以下
- **方法**: 人間が個別に「こう変えて」と指示
- **完了**: 全データの構造化完了

## 実装仕様

### 分解処理エンジン
```javascript
class WorkItemParser {
  // 基本分解ルール
  parseWorkItem(originalText, price) {
    // 1. 位置パターン抽出
    // 2. 対象パターン抽出
    // 3. 動作パターン抽出
    // 4. 複数作業判定
    // 5. 個別/セット振り分け
  }

  // 段階的改善用
  addParsingRule(pattern, extractionLogic) {
    // 新しいパターンを動的追加
  }
}
```

### データ管理
```
outputs/
├── processed_data.json      # 正常に分解できたデータ
├── unprocessed_data.json    # 分解できなかったデータ
├── processing_log.json      # 処理ログ
└── parsing_rules.json       # 追加した分解ルール
```

### 関連設定生成
分解完了後、実績データから自動生成：
```sql
-- 対象→動作の関連（実際に使われた組み合わせ）
INSERT INTO target_actions (target_id, action_id)
SELECT DISTINCT t.id, a.id
FROM processed_work_items pwi
JOIN targets t ON t.name = pwi.target
JOIN actions a ON a.name = pwi.action;

-- 動作→位置の関連（実際に使われた組み合わせ）
INSERT INTO action_positions (action_id, position_id)  
SELECT DISTINCT a.id, p.id
FROM processed_work_items pwi
JOIN actions a ON a.name = pwi.action
JOIN positions p ON p.name = pwi.position;
```

## 継続メンテナンス

### 新データ追加時
1. **同じスクリプト使用**: 蓄積された分解ルールを活用
2. **未処理データ確認**: 新しいパターンがないかチェック
3. **ルール追加**: 必要に応じて新しい判断材料を追加
4. **関連設定更新**: 新しい組み合わせを関連設定に反映

### 品質管理
- **処理率モニタリング**: 成功率の追跡
- **辞書データ拡充**: 不足している対象・動作・位置の追加
- **関連設定最適化**: 頻度の低い関連の除去

## 期待される成果

### データベースの完成
- **完全な過去実績**: 全請求書データが構造化形式で利用可能
- **実績ベース辞書**: 実際に使われた対象・動作・位置のマスターデータ
- **完全な関連設定**: 現在11.2%のカバー率を大幅改善

### システムの向上
- **入力補助機能**: より実用的な候補提案
- **業務効率化**: 過去の実績に基づいた作業パターン活用
- **データ整合性**: 既発行請求書との完全な整合性維持

---

**重要**: このマニュアルは段階的改善プロセスの道標です。完璧を最初から目指さず、継続的な改善により品質を向上させることが重要です。