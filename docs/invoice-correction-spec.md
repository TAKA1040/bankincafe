# 請求書修正・赤伝処理仕様書

## 概要

請求書の修正は、月〆処理の前後で処理方法が異なる。
経理原則に従い、確定済み請求書は直接削除せず、赤伝（マイナス伝票）で相殺する。

---

## 請求書番号の枝番ルール

### 形式
```
YYMM連番-枝番
例: 25123695-1
```

- `25`: 年（2025年）
- `12`: 月
- `3695`: 連番
- `-1`: 枝番（初回発行は1、修正ごとに+1）

### 枝番の意味
| 枝番 | 意味 |
|------|------|
| -1 | 初回発行 |
| -2 | 1回目の修正（または赤伝） |
| -3 | 2回目の修正（または黒伝） |
| ... | 以降同様 |

---

## 月〆前の修正

### 条件
- 請求書のステータスが `draft`（下書き）または `finalized`（確定）
- 月〆処理がまだ実行されていない

### 処理内容
1. 既存の請求書データを直接更新
2. 枝番を+1する（例: `-1` → `-2`）
3. 元の枝番のデータは履歴として保持（`status = 'revised'`）

### 操作フロー
```
請求書詳細画面 → 編集ボタン → 請求書編集画面 → 保存
```

---

## 月〆後の修正

### 条件
- 月〆処理が実行済み
- 請求書のステータスが `closed`（締め済み）

### 処理内容
月〆後は直接変更不可。以下の伝票を自動発行する。

#### 金額変更の場合（例: ¥10,000 → ¥12,000）
1. **赤伝発行**: 元請求のマイナス伝票（-¥10,000）
2. **黒伝発行**: 正しい金額の請求書（¥12,000）

```
25123695-1  ¥10,000   元の請求書（変更不可）
25123695-2  -¥10,000  赤伝（相殺用）
25123695-3  ¥12,000   黒伝（正しい金額）
```

#### 削除の場合
1. 削除ボタン押下 → 強制的に赤伝処理
2. 赤伝のみ発行（黒伝なし）

```
25123695-1  ¥10,000   元の請求書
25123695-2  -¥10,000  赤伝（全額相殺）
```

### 操作フロー
```
請求書詳細画面 → 編集ボタン → 請求書編集画面 → 保存
  → システムが自動的に赤伝+黒伝を生成

請求書詳細画面 → 削除ボタン → 確認ダイアログ → 赤伝発行
```

---

## 請求書の出力形式

月〆後に修正が入った請求書は、以下の形式で出力可能。

| 出力形式 | 内容 | 用途 |
|----------|------|------|
| +請求 | 黒伝のみ出力 | 追加請求 |
| -請求 | 赤伝のみ出力 | 返金・相殺の証憑 |
| 訂正後金額 | 最新の正しい金額 | 取引先への最終請求 |
| 履歴一覧 | 全ての伝票を時系列表示 | 内部管理・監査用 |

---

## データベース設計

### invoicesテーブル追加カラム

| カラム名 | 型 | 説明 |
|----------|------|------|
| invoice_type | TEXT | 'standard'=通常 / 'red'=赤伝 / 'black'=黒伝 |
| original_invoice_id | TEXT | 修正元の請求書ID（赤伝・黒伝の場合） |
| closed_at | TIMESTAMP | 月〆日時（NULLなら未〆） |

※枝番は`invoice_id`から取得（例: "25123695-1" → 枝番=1）

### ステータス一覧

| status | 説明 |
|--------|------|
| draft | 下書き |
| finalized | 確定（発行済み） |
| revised | 修正済み（旧版） |
| closed | 月〆済み |
| cancelled | 赤伝で相殺済み |

---

## 月〆処理

### 処理内容
1. 対象月の全請求書を `closed` ステータスに更新
2. `closed_at` に処理日時を記録
3. 以降、直接編集不可（赤伝・黒伝でのみ修正可能）

### 月〆の取消
- 基本的に取消不可
- 緊急時は管理者権限で `closed_at` をNULLに戻す

---

## 売上計算ルール

### 月次売上
```
月次売上 = Σ(通常請求 + 黒伝) - Σ(赤伝)
```

### 顧客別売上
同一請求書番号（枝番除く）の伝票を合算して計算。

---

## 返金・相殺について

返金処理（銀行振込）か翌月相殺かの選択は、システム機能としては実装しない。
メモ欄に「返金処理」「翌月相殺」等を記載して運用で対応する。

---

## 監査証跡

以下の情報を自動記録する。

- 変更日時（updated_at）
- 変更者（updated_by）※将来実装
- 変更理由（revision_note）※将来実装

---

## 画面遷移

```
請求書一覧
  ↓
請求書詳細（invoice-view）
  ├→ 編集ボタン → 請求書編集（invoice-create?edit=xxx）
  │                 └→ 保存 → 月〆前: 直接更新
  │                         → 月〆後: 赤伝+黒伝生成
  ├→ 削除ボタン → 確認 → 赤伝生成
  ├→ 印刷ボタン → 印刷画面（invoice-print）
  └→ PDF出力 → ダウンロード

修正伝票一覧（月末まとめてDL用）
  └→ 赤伝・黒伝の一覧表示・一括ダウンロード
```

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-10 | 初版作成 |
