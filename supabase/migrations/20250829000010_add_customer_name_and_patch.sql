-- 請求書テーブルにcustomer_nameカラム追加とパッチデータ適用
-- 作成日: 2025-08-29

-- =====================================
-- 1. customer_nameカラム追加
-- =====================================

-- invoicesテーブルにcustomer_nameカラムを追加
ALTER TABLE invoices 
ADD COLUMN IF NOT EXISTS customer_name TEXT;

-- =====================================
-- 2. パッチデータの適用（50件の顧客情報補完）
-- =====================================

-- 空欄補完ポリシー: 既存値が空またはNULLの場合のみ更新

-- 請求書の顧客情報を一括更新
UPDATE invoices SET 
  customer_name = COALESCE(NULLIF(TRIM(invoices.customer_name), ''), patch.customer_name),
  subject_name = COALESCE(NULLIF(TRIM(invoices.subject_name), ''), patch.subject_name),
  registration_number = COALESCE(NULLIF(TRIM(invoices.registration_number), ''), patch.registration_number)
FROM (VALUES
  ('25043369-1', 'UDトラックス株式会社', '株式会社バンテック九州', '北九州100え3686'),
  ('25043370-1', 'UDトラックス株式会社', '岡田設備株式会社', '佐賀100か6677'),
  ('25043370-2', 'UDトラックス株式会社', '岡田設備株式会社', '佐賀100か6677'),
  ('25043371-1', 'UDトラックス株式会社', 'パッシブル有限会社', '北九州130あ･550'),
  ('25043372-1', 'UDトラックス株式会社', '久富産業株式会社', '北九州100き4739'),
  ('25043373-1', 'UDトラックス株式会社', '株式会社サクラ物流', '北九州130い･759'),
  ('25043374-1', 'UDトラックス株式会社', '株式会社バンテック', '北九州130う･416'),
  ('25043375-1', 'UDトラックス株式会社', '株式会社バンテック', '北九州130あ4204'),
  ('25043376-1', 'UDトラックス株式会社', '株式会社バンテック', '北九州130い4050'),
  ('25043377-1', 'UDトラックス株式会社', '有限会社堀本建設', '北九州131あ･400'),
  ('25043378-1', 'UDトラックス株式会社', '株式会社森若商会', '北九州130う1971'),
  ('25043379-1', 'UDトラックス株式会社', '株式会社バンテック九州', '北九州130い1056'),
  ('25043380-1', 'UDトラックス株式会社', '株式会社サクラ物流', '北九州130い･792'),
  ('25043385-1', 'UDトラックス株式会社', '株式会社バンテック九州', '北九州100き3879'),
  ('25043385-2', 'UDトラックス株式会社', '株式会社バンテック九州', '北九州100き3879'),
  ('25053381-1', 'UDトラックス株式会社', '株式会社稲田運輸', '北九州130ふ4444'),
  ('25053382-1', 'UDトラックス株式会社', 'ユニプレス物流株式会社', '北九州100き4904'),
  ('25053383-1', 'UDトラックス株式会社', '無', '不明999ん9998'),
  ('25053384-1', 'UDトラックス株式会社', '鶴丸海運株式会社', '北九州130か･901'),
  ('25053386-1', 'UDトラックス株式会社', '株式会社バンテック九州', '北九州100き3879'),
  ('25053387-1', 'UDトラックス株式会社', '株式会社共和', '北九州830い･706'),
  ('25053388-1', 'UDトラックス株式会社', '株式会社サクラ物流', '北九州130い･774'),
  ('25053389-1', 'UDトラックス株式会社', '株式会社ゼロ･プラス九州　九州カスタマーサービスセンター', '北九州800す4487'),
  ('25053390-1', 'UDトラックス株式会社', '株式会社バンテック', '北九州100え3686'),
  ('25053391-1', 'UDトラックス株式会社', '有限会社行橋鎮西運送', '北九州100あ1629'),
  ('25053392-1', 'UDトラックス株式会社', '株式会社太田古鐵商店', '北九州130さ･･47'),
  ('25053393-1', 'UDトラックス株式会社', 'ケーエムサービス株式会社', '北九州100え4853'),
  ('25053394-1', 'UDトラックス株式会社', '東邦興産株式会社', '北九州100え4988'),
  ('25053395-1', 'UDトラックス株式会社', '岡田設備株式会社', '佐賀100か6677'),
  ('25053396-1', 'UDトラックス株式会社', '株式会社サクラ物流', '北九州130い･812'),
  ('25053397-1', 'UDトラックス株式会社', '株式会社　VIP', '北九州130いえ1025'),
  ('25053398-1', 'UDトラックス株式会社', '鶴丸海運株式会社', '北九州100え2900'),
  ('25053399-1', 'UDトラックス株式会社', '株式会社サクラ物流', '北九州130あ･822'),
  ('25053400-1', 'UDトラックス株式会社', '久富産業株式会社', '北九州11け4317'),
  ('25053401-1', 'UDトラックス株式会社', '有限会社井手梱包', '北九州100あ7481'),
  ('25053401-2', 'UDトラックス株式会社', '有限会社井手梱包', '北九州100あ7481'),
  ('25053402-1', 'UDトラックス株式会社', '株式会社サクラ物流', '北九州130い･759'),
  ('25053403-1', 'UDトラックス株式会社', '有限会社行橋鎮西運送', '北九州100キ･･43'),
  ('25053404-1', 'UDトラックス株式会社', '田村運輸株式会社', '北九州100キ5011'),
  ('25053405-1', 'UDトラックス株式会社', '鶴丸海運株式会社', '北九州100え3245'),
  ('25053406-1', 'UDトラックス株式会社', '三原物流株式会社', '北九州800か2669'),
  ('25053407-1', 'UDトラックス株式会社', '株式会社太田古鐵商店', '北九州130そ･･11'),
  ('25053408-1', 'UDトラックス株式会社', 'ケーエムサービス株式会社', '北九州100え4953'),
  ('25053409-1', 'UDトラックス株式会社', '有限会社堀本建設', '北九州131あ･400'),
  ('25053410-1', 'UDトラックス株式会社', '株式会社ロジコム・アイ', '北九州100き5026'),
  ('25053411-1', 'UDトラックス株式会社', '久富産業株式会社', '北九州100え1104'),
  ('25053412-1', 'UDトラックス株式会社', '有限会社井手梱包', '北九州100か5756'),
  ('25053413-1', 'UDトラックス株式会社', '株式会社バンテック', '北九州130あ4012'),
  ('25053414-1', 'UDトラックス株式会社', '田村運輸株式会社', '北九州100き3500'),
  ('25053415-1', 'UDトラックス株式会社', '株式会社白石開発', '北九州100え5124')
) AS patch(invoice_id, customer_name, subject_name, registration_number)
WHERE invoices.invoice_id = patch.invoice_id;

-- =====================================
-- 3. インデックス追加
-- =====================================

-- customer_name用のインデックス（検索用）
CREATE INDEX IF NOT EXISTS idx_invoices_customer_name ON invoices(customer_name);

-- =====================================
-- 4. データ検証
-- =====================================

-- 補完結果の確認クエリ
DO $$
DECLARE
    total_invoices INTEGER;
    filled_customers INTEGER;
    filled_subjects INTEGER;
    filled_registrations INTEGER;
BEGIN
    SELECT COUNT(*) INTO total_invoices FROM invoices;
    SELECT COUNT(*) INTO filled_customers FROM invoices WHERE customer_name IS NOT NULL AND TRIM(customer_name) != '';
    SELECT COUNT(*) INTO filled_subjects FROM invoices WHERE subject_name IS NOT NULL AND TRIM(subject_name) != '';
    SELECT COUNT(*) INTO filled_registrations FROM invoices WHERE registration_number IS NOT NULL AND TRIM(registration_number) != '';
    
    RAISE NOTICE '=== 顧客情報補完結果 ===';
    RAISE NOTICE '総請求書数: %', total_invoices;
    RAISE NOTICE '顧客名補完数: %', filled_customers;
    RAISE NOTICE '件名補完数: %', filled_subjects;
    RAISE NOTICE '登録番号補完数: %', filled_registrations;
    RAISE NOTICE '========================';
END$$;

-- =====================================
-- 5. コメント追加
-- =====================================

COMMENT ON COLUMN invoices.customer_name IS '顧客名（請求先）- パッチファイルで補完';
COMMENT ON TABLE invoices IS '請求書ヘッダー - 顧客情報補完済み';

-- 完了メッセージ
SELECT '✅ 請求書顧客情報（50件）補完完了 - invoice-list準備OK' as result;