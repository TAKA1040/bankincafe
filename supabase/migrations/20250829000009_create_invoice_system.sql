-- 請求書システムのテーブル作成とデータインポート
-- ChatGPT提案スクリプトをSupabase用にアレンジ
-- 作成日: 2025-08-29

-- =====================================
-- 1. 請求書関連テーブル作成
-- =====================================

-- 請求書ヘッダーテーブル
CREATE TABLE IF NOT EXISTS invoices (
  invoice_id TEXT PRIMARY KEY,
  issue_date DATE,
  subject_name TEXT,
  registration_number TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- 請求書明細テーブル
CREATE TABLE IF NOT EXISTS invoice_line_items (
  id BIGSERIAL PRIMARY KEY,
  invoice_id TEXT NOT NULL REFERENCES invoices(invoice_id) ON DELETE CASCADE,
  line_no INTEGER NOT NULL,
  task_type TEXT NOT NULL,           -- 'fuzzy' | 'structured' | 'set' など
  action TEXT,                       -- structured なら値、fuzzyなら空
  target TEXT,
  position TEXT,                     -- 指定なしはNULL運用を推奨
  raw_label TEXT,                    -- 旧データの生文字列
  unit_price NUMERIC(12,0) DEFAULT 0,
  quantity INTEGER DEFAULT 1,
  performed_at DATE,
  amount NUMERIC(12,0) DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(invoice_id, line_no)
);

-- =====================================
-- 2. インデックス作成
-- =====================================

CREATE INDEX IF NOT EXISTS idx_invoice_line_items_invoice_id ON invoice_line_items(invoice_id);
CREATE INDEX IF NOT EXISTS idx_invoice_line_items_performed_at ON invoice_line_items(performed_at);
CREATE INDEX IF NOT EXISTS idx_invoices_issue_date ON invoices(issue_date);

-- =====================================
-- 3. トリガー設定
-- =====================================

-- updated_at自動更新トリガー
DROP TRIGGER IF EXISTS trg_invoices_updated ON invoices;
CREATE TRIGGER trg_invoices_updated BEFORE UPDATE ON invoices
  FOR EACH ROW EXECUTE FUNCTION set_updated_at();

DROP TRIGGER IF EXISTS trg_invoice_line_items_updated ON invoice_line_items;
CREATE TRIGGER trg_invoice_line_items_updated BEFORE UPDATE ON invoice_line_items
  FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- =====================================
-- 4. 請求書データのインポート
-- =====================================

-- 請求書ヘッダーデータ（50件）
INSERT INTO invoices (invoice_id, issue_date, subject_name, registration_number) VALUES
('25043369-1', '2025-04-24', '', ''),
('25043370-1', '2025-04-24', '', ''),
('25043370-2', '2025-04-24', '', ''),
('25043371-1', '2025-04-27', '', ''),
('25043372-1', '2025-04-27', '', ''),
('25043373-1', '2025-04-27', '', ''),
('25043374-1', '2025-04-27', '', ''),
('25043375-1', '2025-04-27', '', ''),
('25043376-1', '2025-04-27', '', ''),
('25043377-1', '2025-04-27', '', ''),
('25043378-1', '2025-04-28', '', ''),
('25043379-1', '2025-04-30', '', ''),
('25043380-1', '2025-04-30', '', ''),
('25043385-1', '2025-05-12', '', ''),
('25043385-2', '2025-05-12', '', ''),
('25053381-1', '2025-05-01', '', ''),
('25053382-1', '2025-05-02', '', ''),
('25053383-1', '2025-05-08', '', ''),
('25053384-1', '2025-05-08', '', ''),
('25053386-1', '2025-05-12', '', ''),
('25053387-1', '2025-05-15', '', ''),
('25053388-1', '2025-05-15', '', ''),
('25053389-1', '2025-05-15', '', ''),
('25053390-1', '2025-05-18', '', ''),
('25053391-1', '2025-05-18', '', ''),
('25053392-1', '2025-05-18', '', ''),
('25053393-1', '2025-05-18', '', ''),
('25053394-1', '2025-05-18', '', ''),
('25053395-1', '2025-05-18', '', ''),
('25053396-1', '2025-05-19', '', ''),
('25053397-1', '2025-05-20', '', ''),
('25053398-1', '2025-05-20', '', ''),
('25053399-1', '2025-05-21', '', ''),
('25053400-1', '2025-05-21', '', ''),
('25053401-1', '2025-05-25', '', ''),
('25053401-2', '2025-05-25', '', ''),
('25053402-1', '2025-05-25', '', ''),
('25053403-1', '2025-05-25', '', ''),
('25053404-1', '2025-05-25', '', ''),
('25053405-1', '2025-05-25', '', ''),
('25053406-1', '2025-05-25', '', ''),
('25053407-1', '2025-05-26', '', ''),
('25053408-1', '2025-05-26', '', ''),
('25053409-1', '2025-05-26', '', ''),
('25053410-1', '2025-05-27', '', ''),
('25053411-1', '2025-05-27', '', ''),
('25053412-1', '2025-05-28', '', ''),
('25053413-1', '2025-05-29', '', ''),
('25053414-1', '2025-05-29', '', ''),
('25053415-1', '2025-05-29', '', '')
ON CONFLICT (invoice_id) DO UPDATE
SET issue_date = EXCLUDED.issue_date,
    subject_name = COALESCE(NULLIF(TRIM(EXCLUDED.subject_name), ''), invoices.subject_name),
    registration_number = COALESCE(NULLIF(TRIM(EXCLUDED.registration_number), ''), invoices.registration_number);

-- =====================================
-- 5. 請求書明細データのインポート
-- =====================================

-- 請求書明細データ（67件）
INSERT INTO invoice_line_items (invoice_id, line_no, task_type, action, target, position, raw_label, unit_price, quantity, performed_at, amount) VALUES
('25043369-1', 1, 'fuzzy', '', '', '', 'リヤフラッシャーASSY取替・ブラケット鈑金修理', 0, 1, '2025-04-24', 0),
('25043370-1', 1, 'fuzzy', '', '', '', 'DPFマフラーセンサーボルト折れ込み修理', 0, 1, '2025-04-24', 0),
('25043370-2', 1, 'fuzzy', '', '', '', 'DPFマフラーセンサーボルト折れ込み修理', 0, 1, '2025-04-24', 0),
('25043371-1', 1, 'fuzzy', '', '', '', '左ファーストステップ・ロアカバー・リフレクター取替・ステップブラケット脱着修正・左ドアフラッシャー取替', 0, 1, '2025-04-27', 0),
('25043372-1', 1, 'fuzzy', '', '', '', 'フロントリッド・グリル脱着・フロントキャブサスマウントリンク脱着リンクブッシュ嚙み込み取外し交換', 0, 1, '2025-04-27', 0),
('25043373-1', 1, 'fuzzy', '', '', '', 'メイン燃料タンクホース延長サブタンク付替え加工', 0, 1, '2025-04-27', 0),
('25043374-1', 1, 'fuzzy', '', '', '', 'リヤバンパー折損鈑金修理', 0, 1, '2025-04-27', 0),
('25043375-1', 1, 'fuzzy', '', '', '', 'タンクバンドマス締め', 0, 1, '2025-04-27', 0),
('25043376-1', 1, 'fuzzy', '', '', '', 'アドブルーキャップ分解取替加工', 0, 1, '2025-04-27', 0),
('25043377-1', 1, 'fuzzy', '', '', '', '右キャブフェンダー回り応急鈑金修理・マッドガード及びステイ取替鈑金加工・タイヤハウスカバー取替加工', 0, 1, '2025-04-27', 0),
('25043378-1', 1, 'fuzzy', '', '', '', 'エンジンカバーステイ修正・折損溶接', 0, 1, '2025-04-28', 0),
('25043378-1', 2, 'fuzzy', '', '', '', 'フロントリッド・グリル・キャブマウントリンク脱着・リンクブッシュ前後切断取替加工', 0, 1, '2025-04-28', 0),
('25043379-1', 1, 'fuzzy', '', '', '', 'センターシート張替加工', 0, 1, '2025-04-30', 0),
('25043379-1', 2, 'fuzzy', '', '', '', '天井周りコーキング処理', 0, 1, '2025-04-30', 0),
('25043380-1', 1, 'fuzzy', '', '', '', '左バックミラー・ステイ・モーター取替', 0, 1, '2025-04-30', 0),
('25043380-1', 2, 'fuzzy', '', '', '', '左ステップカバー・ドアー補修塗装', 0, 1, '2025-04-30', 0),
('25043380-1', 3, 'fuzzy', '', '', '', '左コーナーパネル・コーナーカバー取替・取り付け部分修正', 0, 1, '2025-04-30', 0),
('25043380-1', 4, 'fuzzy', '', '', '', 'インナーバンパー・左フィニッシャー・エンドカバー・ヘッドライト・フォグランプ・フラッシャー取替・他部品組替', 0, 1, '2025-04-30', 0),
('25043380-1', 5, 'fuzzy', '', '', '', '左右ファーストステップブラケット脱着修正・左側ステイ取替', 0, 1, '2025-04-30', 0),
('25043385-1', 1, 'fuzzy', '', '', '', 'ホイール塗装4本', 0, 1, '2025-05-12', 0),
('25043385-2', 1, 'fuzzy', '', '', '', '取消', 0, 1, '2025-05-12', 0),
('25053381-1', 1, 'fuzzy', '', '', '', '左右当たりゴム取外し加工', 0, 1, '2025-05-01', 0),
('25053381-1', 2, 'fuzzy', '', '', '', 'フロンバンパー脱着・左右フォグランプステイ取り外し・ガードバンパーボルトワッシャー4枚製作取付', 0, 1, '2025-05-01', 0),
('25053382-1', 1, 'fuzzy', '', '', '', 'センタースロットル・レール鈑金加工', 0, 1, '2025-05-02', 0),
('25053383-1', 1, 'fuzzy', '', '', '', '工場内清掃代行', 0, 1, '2025-05-08', 0),
('25053384-1', 1, 'fuzzy', '', '', '', 'プラットホームブッシュ張替加工', 0, 1, '2025-05-08', 0),
('25053386-1', 1, 'fuzzy', '', '', '', 'ホイール塗装4本', 0, 1, '2025-05-12', 0),
('25053387-1', 1, 'fuzzy', '', '', '', '左右大型反射板取替(傘リベット8本込み）', 0, 1, '2025-05-15', 0),
('25053388-1', 1, 'fuzzy', '', '', '', '右後ろシリンダーピン折れ込み取替加工・蝶番点検', 0, 1, '2025-05-15', 0),
('25053389-1', 1, 'fuzzy', '', '', '', '内装脱着貼替加工', 0, 1, '2025-05-15', 0),
('25053389-1', 2, 'fuzzy', '', '', '', '錆止め塗装', 0, 1, '2025-05-15', 0),
('25053389-1', 3, 'fuzzy', '', '', '', 'ボデー左前ドアー脱着鈑金・コーナーポスト切断脱着鈑金', 0, 1, '2025-05-15', 0),
('25053390-1', 1, 'fuzzy', '', '', '', 'クロスメンバー亀裂2ヵ所カット溶接', 0, 1, '2025-05-18', 0),
('25053391-1', 1, 'fuzzy', '', '', '', '左ウィングキャッチ受け鈑金・シート1部脱着リベット打ち替え加工', 0, 1, '2025-05-18', 0),
('25053392-1', 1, 'fuzzy', '', '', '', '左右ドアウェザーストリップゴム取替・スカッフプレート脱着腐食ビス取替加工', 0, 1, '2025-05-18', 0),
('25053392-1', 2, 'fuzzy', '', '', '', '右ドアー内張脱着・ラッチ取替', 0, 1, '2025-05-18', 0),
('25053393-1', 1, 'fuzzy', '', '', '', 'クロスメンバー亀裂カット溶接', 0, 1, '2025-05-18', 0),
('25053394-1', 1, 'fuzzy', '', '', '', '左後ろセイコーラック取替加工', 0, 1, '2025-05-18', 0),
('25053395-1', 1, 'fuzzy', '', '', '', '持ち込みマフラー分解脱着・UDPC・DOC清掃付替え加工・折れ込みボルト修理4本・フェンダー脱着', 0, 1, '2025-05-18', 0),
('25053396-1', 1, 'fuzzy', '', '', '', 'ドライバーシートリクライニング取替', 0, 1, '2025-05-19', 0),
('25053396-1', 2, 'fuzzy', '', '', '', 'タンクバンド２本取替', 0, 1, '2025-05-19', 0),
('25053397-1', 1, 'fuzzy', '', '', '', 'リヤゲート嚙み込み修理・ダンプキャッチ2個分解修理・キャッチロックボールジョイント取付加工溶接・ポール2本曲がり直し亀裂溶接', 0, 1, '2025-05-20', 0),
('25053398-1', 1, 'fuzzy', '', '', '', 'ウィング蝶番点検グリスアップ・枠骨異音点検ボルト取付加工３ヶ所', 0, 1, '2025-05-20', 0),
('25053399-1', 1, 'fuzzy', '', '', '', '左右スケット分解調整4ヶ所', 0, 1, '2025-05-21', 0),
('25053400-1', 1, 'fuzzy', '', '', '', '駐車ブレーキブラケット亀裂2ヵ所カット溶整', 0, 1, '2025-05-21', 0),
('25053401-1', 1, 'fuzzy', '', '', '', '右ストッパー交換・ボルト嚙み込み修理', 0, 1, '2025-05-25', 0),
('25053401-2', 1, 'fuzzy', '', '', '', '右ストッパー交換', 0, 1, '2025-05-25', 0),
('25053402-1', 1, 'fuzzy', '', '', '', 'サイドガード脱着・燃料タンク2個脱着入替・付属品付替え', 0, 1, '2025-05-25', 0),
('25053403-1', 1, 'fuzzy', '', '', '', '右ドアミラーアーム脱着ボルト取り替え加工', 0, 1, '2025-05-25', 0),
('25053404-1', 1, 'fuzzy', '', '', '', '左右スケット4個調整', 0, 1, '2025-05-25', 0),
('25053405-1', 1, 'fuzzy', '', '', '', 'ウィング蝶番点検・グリスアップ・煽りドアスケット調整', 0, 1, '2025-05-25', 0),
('25053406-1', 1, 'fuzzy', '', '', '', 'ドライバーシートブラケット交換', 0, 1, '2025-05-25', 0),
('25053407-1', 1, 'fuzzy', '', '', '', 'ジャバラパイプ脱着・エキゾーストパイプ折損修正溶接', 0, 1, '2025-05-26', 0),
('25053408-1', 1, 'fuzzy', '', '', '', 'クロスメンバー亀裂溶接', 0, 1, '2025-05-26', 0),
('25053409-1', 1, 'fuzzy', '', '', '', 'ホーン交換・ステイ交換・ブラケット鈑金修理', 0, 1, '2025-05-26', 0),
('25053409-1', 2, 'fuzzy', '', '', '', '右ステップパネル取替鈑金', 0, 1, '2025-05-26', 0),
('25053409-1', 3, 'fuzzy', '', '', '', '右コーナーパネル脱着', 0, 1, '2025-05-26', 0),
('25053409-1', 4, 'fuzzy', '', '', '', '右ロアフェンダー取替・取り付け修正', 0, 1, '2025-05-26', 0),
('25053409-1', 5, 'fuzzy', '', '', '', '右アッパーフェンダー取替・取り付け修正・タイヤハウスカバー脱着', 0, 1, '2025-05-26', 0),
('25053409-1', 6, 'fuzzy', '', '', '', '右ドアパネル内側鈑金', 0, 1, '2025-05-26', 0),
('25053410-1', 1, 'fuzzy', '', '', '', 'リヤナンバーボルト折れ込み修理', 0, 1, '2025-05-27', 0),
('25053411-1', 1, 'fuzzy', '', '', '', 'コンテナロックガード取替', 0, 1, '2025-05-27', 0),
('25053411-1', 2, 'fuzzy', '', '', '', '左サイドガード折損部分切替溶接・フラッシャーステイ切断付替え加工・錆止め塗装', 0, 1, '2025-05-27', 0),
('25053412-1', 1, 'fuzzy', '', '', '', '右後ろウィングキャッチ受け・コーナーガード取り替え加工', 0, 1, '2025-05-28', 0),
('25053413-1', 1, 'fuzzy', '', '', '', 'バッテリー縞板キャッチ取替調整', 0, 1, '2025-05-29', 0),
('25053414-1', 1, 'fuzzy', '', '', '', 'リヤナンバーブラケット折損溶接', 0, 1, '2025-05-29', 0),
('25053415-1', 1, 'fuzzy', '', '', '', '右後ろ煽りスケット応急取外し', 0, 1, '2025-05-29', 0)
ON CONFLICT (invoice_id, line_no) DO UPDATE
SET task_type = EXCLUDED.task_type,
    action = EXCLUDED.action,
    target = EXCLUDED.target,
    position = EXCLUDED.position,
    raw_label = EXCLUDED.raw_label,
    unit_price = EXCLUDED.unit_price,
    quantity = EXCLUDED.quantity,
    performed_at = EXCLUDED.performed_at,
    amount = EXCLUDED.amount;

-- =====================================
-- 6. データ検証とコメント
-- =====================================

COMMENT ON TABLE invoices IS '請求書ヘッダーテーブル - CSVインポート済み';
COMMENT ON TABLE invoice_line_items IS '請求書明細テーブル - CSVインポート済み';
COMMENT ON COLUMN invoice_line_items.task_type IS 'fuzzy: 非構造化データ、structured: 構造化データ';
COMMENT ON COLUMN invoice_line_items.raw_label IS '元の作業内容テキスト';

-- 完了メッセージ
SELECT '✅ 請求書システム（50件の請求書、67件の明細）インポート完了' as result;