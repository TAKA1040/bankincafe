# invoice-create ç”»é¢é …ç›® â†’ DB ãƒãƒƒãƒ”ãƒ³ã‚°ç¢ºèª

## æœ€çµ‚ç¢ºèªæ—¥: 2024-12-12

## ========================================
## ğŸ“‹ åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (invoices ãƒ†ãƒ¼ãƒ–ãƒ«)
## ========================================

| ç”»é¢ã®é …ç›®å | DBåˆ—å | ç¾çŠ¶ |
|-------------|--------|------|
| è«‹æ±‚æ›¸No | invoice_id, invoice_number | âœ… OK |
| è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å¹´æœˆ | billing_month | âœ… OK ("2025-01"å½¢å¼) |
| è«‹æ±‚æ—¥ï¼ˆç™ºè¡Œæ—¥ï¼‰ | billing_date | âœ… OK |
| (è‡ªå‹•è¨­å®š) | issue_date | âœ… OK (ä¿å­˜æ™‚ã®æ—¥ä»˜) |
| é¡§å®¢ã‚«ãƒ†ã‚´ãƒª | customer_category | âœ… OK |
| é¡§å®¢å | customer_name | âœ… OK |
| ä»¶å | subject, subject_name | âœ… OK |
| ç™»éŒ²ç•ªå·ï¼ˆä»»æ„ï¼‰ | registration_number | âœ… OK |
| ç™ºæ³¨ç•ªå·ï¼ˆä»»æ„ï¼‰ | order_number | âœ… OK |
| ã‚ªãƒ¼ãƒ€ãƒ¼ç•ªå·ï¼ˆä»»æ„ï¼‰ | purchase_order_number | âœ… OK |
| (å‚™è€ƒæ¬„ãŒã‚ã‚Œã°) | remarks | âœ… OK |
| (è¨ˆç®—å€¤) | subtotal | âœ… OK |
| (è¨ˆç®—å€¤) | tax | âœ… OK |
| (è¨ˆç®—å€¤) | total_amount | âœ… OK |

---

## ========================================
## ğŸ› ï¸ ä½œæ¥­é …ç›®å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (invoice_line_items ãƒ†ãƒ¼ãƒ–ãƒ«)
## ========================================

### ã€å€‹åˆ¥ä½œæ¥­ã‚¿ãƒ–ã€‘ã®å…¥åŠ›é …ç›®

| ç”»é¢ã®é …ç›®å | DBåˆ—å | ç¾çŠ¶ | å•é¡Œ |
|-------------|--------|------|------|
| å¯¾è±¡ | target | âŒ work_nameä¿å­˜ä¸­ | çµ„ã¿ç«‹ã¦ãƒ©ãƒ™ãƒ«ã§ã¯ãªãå¯¾è±¡ã®ã¿ä¿å­˜ã™ã¹ã |
| å‹•ä½œ | action1, action2, action3 | âŒ null | æœªå®Ÿè£… |
| ä½ç½® | position1~position5 | âŒ null | æœªå®Ÿè£… |
| ãã®ä»– | memo? | âŒ ä¸æ˜ | åˆ—ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªå¿…è¦ |
| å˜ä¾¡ | unit_price | âœ… OK | |
| æ•°é‡ | quantity | âœ… OK | |
| (è¨ˆç®—å€¤) | amount | âœ… OK | |

### ã€ã‚»ãƒƒãƒˆä½œæ¥­ã‚¿ãƒ–ã€‘ã®å…¥åŠ›é …ç›®

| ç”»é¢ã®é …ç›®å | DBåˆ—å | ç¾çŠ¶ | å•é¡Œ |
|-------------|--------|------|------|
| ã‚»ãƒƒãƒˆå | set_name | âœ… OK | |
| ã‚»ãƒƒãƒˆä¾¡æ ¼ | unit_price | âœ… OK | |
| ã‚»ãƒƒãƒˆæ•°é‡ | quantity | âœ… OK | |
| ã‚»ãƒƒãƒˆæ˜ç´° | raw_label_part | âœ… OK | å„å­è¡Œã«ä¿å­˜ |

---

## ========================================
## ç¾åœ¨ã®ä¿å­˜ã‚³ãƒ¼ãƒ‰ (page.tsx 1717-1786è¡Œç›®)
## ========================================

### å€‹åˆ¥ä½œæ¥­ã®ä¿å­˜ã‚³ãƒ¼ãƒ‰
```typescript
// å€‹åˆ¥ä½œæ¥­ï¼ˆtask_type='T'ï¼‰
lineItems.push({
  invoice_id: savedInvoiceId,
  line_no: lineNo,
  sub_no: 1,
  task_type: 'T',
  target: item.work_name,        // â† å•é¡Œ: å¯¾è±¡ã§ã¯ãªãçµ„ã¿ç«‹ã¦ãƒ©ãƒ™ãƒ«
  raw_label: item.work_name,
  raw_label_part: item.work_name,
  unit_price: item.unit_price,
  quantity: item.quantity,
  amount: amount,
  performed_at: billingDate
  // action1, action2, action3: æœªå®Ÿè£…
  // position1~5: æœªå®Ÿè£…
})
```

### ã‚»ãƒƒãƒˆä½œæ¥­ã®ä¿å­˜ã‚³ãƒ¼ãƒ‰
```typescript
// ã‚»ãƒƒãƒˆä½œæ¥­ï¼ˆtask_type='S'ï¼‰
lineItems.push({
  invoice_id: savedInvoiceId,
  line_no: lineNo,
  sub_no: 1,
  task_type: 'S',
  target: item.work_name,
  set_name: item.work_name,       // âœ… OK
  raw_label: item.set_details.join('ã€'),
  raw_label_part: detail,         // âœ… OK
  unit_price: item.unit_price,
  quantity: item.quantity,
  amount: amount,
  performed_at: billingDate
})
```

---

## ========================================
## å¿…è¦ãªä¿®æ­£
## ========================================

### 1. WorkItemå‹ã®æ‹¡å¼µ
```typescript
interface WorkItem {
  work_name: string       // çµ„ã¿ç«‹ã¦ãƒ©ãƒ™ãƒ«ï¼ˆè¡¨ç¤ºç”¨ï¼‰
  target?: string         // å¯¾è±¡ï¼ˆNEWï¼‰
  action1?: string        // å‹•ä½œ1ï¼ˆNEWï¼‰
  action2?: string        // å‹•ä½œ2ï¼ˆNEWï¼‰
  action3?: string        // å‹•ä½œ3ï¼ˆNEWï¼‰
  position1?: string      // ä½ç½®1ï¼ˆNEWï¼‰
  position2?: string      // ä½ç½®2ï¼ˆNEWï¼‰
  position3?: string      // ä½ç½®3ï¼ˆNEWï¼‰
  position4?: string      // ä½ç½®4ï¼ˆNEWï¼‰
  position5?: string      // ä½ç½®5ï¼ˆNEWï¼‰
  memo?: string           // ãã®ä»–ï¼ˆNEWï¼‰
  unit_price: number
  quantity: number
  type: 'individual' | 'set'
  set_details?: string[]
}
```

### 2. ä¿å­˜ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£
```typescript
// å€‹åˆ¥ä½œæ¥­ã®ä¿å­˜
lineItems.push({
  invoice_id: savedInvoiceId,
  line_no: lineNo,
  sub_no: 1,
  task_type: 'T',
  target: item.target,            // å¯¾è±¡ã®ã¿
  action1: item.action1 || null,
  action2: item.action2 || null,
  action3: item.action3 || null,
  position1: item.position1 || null,
  position2: item.position2 || null,
  position3: item.position3 || null,
  position4: item.position4 || null,
  position5: item.position5 || null,
  memo: item.memo || null,
  raw_label: item.work_name,      // çµ„ã¿ç«‹ã¦ãƒ©ãƒ™ãƒ«ï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
  raw_label_part: item.work_name,
  unit_price: item.unit_price,
  quantity: item.quantity,
  amount: amount,
  performed_at: billingDate
})
```

---

## ========================================
## DBåˆ—ä¸€è¦§ (invoice_line_items)
## ========================================

- invoice_id âœ…
- line_no âœ…
- sub_no âœ…
- task_type ('T'=å€‹åˆ¥, 'S'=ã‚»ãƒƒãƒˆ) âœ…
- target âŒ (çµ„ã¿ç«‹ã¦ãƒ©ãƒ™ãƒ«ãŒå…¥ã£ã¦ã„ã‚‹)
- action1 âŒ (æœªä½¿ç”¨)
- action2 âŒ (æœªä½¿ç”¨)
- action3 âŒ (æœªä½¿ç”¨)
- position1 âŒ (æœªä½¿ç”¨)
- position2 âŒ (æœªä½¿ç”¨)
- position3 âŒ (æœªä½¿ç”¨)
- position4 âŒ (æœªä½¿ç”¨)
- position5 âŒ (æœªä½¿ç”¨)
- set_name âœ…
- raw_label âœ…
- raw_label_part âœ…
- unit_price âœ…
- quantity âœ…
- amount âœ…
- performed_at âœ…
