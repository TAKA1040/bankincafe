# invoice-create ç”»é¢é …ç›® â†’ DB ãƒãƒƒãƒ”ãƒ³ã‚°ç¢ºèª

## æœ€çµ‚ç¢ºèªæ—¥: 2025-12-12

## ========================================
## ğŸ“‹ åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (invoices ãƒ†ãƒ¼ãƒ–ãƒ«)
## ========================================

| ç”»é¢ã®é …ç›®å | DBåˆ—å | ç¾çŠ¶ |
|-------------|--------|------|
| è«‹æ±‚æ›¸No | invoice_id, invoice_number | âœ… OK |
| è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å¹´æœˆ | billing_month | âœ… OK ("2025-01"å½¢å¼) |
| è«‹æ±‚æ—¥ï¼ˆç™ºè¡Œæ—¥ï¼‰ | billing_date | âœ… OK |
| (è‡ªå‹•è¨­å®š) | issue_date | âœ… OK (ä¿å­˜æ™‚ã®æ—¥ä»˜) |
| é¡§å®¢ã‚«ãƒ†ã‚´ãƒª | customer_category | âœ… OK |
| é¡§å®¢å | customer_name | âœ… OK |
| ä»¶å | subject, subject_name | âœ… OK |
| ç™»éŒ²ç•ªå·ï¼ˆä»»æ„ï¼‰ | registration_number | âœ… OK |
| ç™ºæ³¨ç•ªå·ï¼ˆä»»æ„ï¼‰ | order_number | âœ… OK |
| ã‚ªãƒ¼ãƒ€ãƒ¼ç•ªå·ï¼ˆä»»æ„ï¼‰ | purchase_order_number | âœ… OK |
| (å‚™è€ƒæ¬„ãŒã‚ã‚Œã°) | remarks | âœ… OK |
| (è¨ˆç®—å€¤) | subtotal | âœ… OK |
| (è¨ˆç®—å€¤) | tax | âœ… OK |
| (è¨ˆç®—å€¤) | total_amount | âœ… OK |

---

## ========================================
## ğŸ› ï¸ ä½œæ¥­é …ç›®å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (invoice_line_items ãƒ†ãƒ¼ãƒ–ãƒ«)
## ========================================

### ã€å€‹åˆ¥ä½œæ¥­ã‚¿ãƒ–ã€‘ã®å…¥åŠ›é …ç›®

| ç”»é¢ã®é …ç›®å | DBåˆ—å | ç¾çŠ¶ |
|-------------|--------|------|
| å¯¾è±¡ | target | âœ… OK |
| å‹•ä½œ | action1, action2, action3 | âœ… OK |
| ä½ç½® | position1~position5 | âœ… OK |
| ãã®ä»– | other | âœ… OK |
| å˜ä¾¡ | unit_price | âœ… OK |
| æ•°é‡ | quantity | âœ… OK |
| (è¨ˆç®—å€¤) | amount | âœ… OK |

### ã€ã‚»ãƒƒãƒˆä½œæ¥­ã‚¿ãƒ–ã€‘ã®å…¥åŠ›é …ç›®

| ç”»é¢ã®é …ç›®å | DBåˆ—å | ç¾çŠ¶ |
|-------------|--------|------|
| ã‚»ãƒƒãƒˆå | set_name | âœ… OK |
| ã‚»ãƒƒãƒˆä¾¡æ ¼ | unit_price | âœ… OK |
| ã‚»ãƒƒãƒˆæ•°é‡ | quantity | âœ… OK |
| ã‚»ãƒƒãƒˆæ˜ç´° | raw_label_part | âœ… OK (å„å­è¡Œã«ä¿å­˜) |
| æ˜ç´°ã®å¯¾è±¡ | target | âœ… OK (å„å­è¡Œã«ä¿å­˜) |
| æ˜ç´°ã®å‹•ä½œ | action1~3 | âœ… OK (å„å­è¡Œã«ä¿å­˜) |
| æ˜ç´°ã®ä½ç½® | position1~5 | âœ… OK (å„å­è¡Œã«ä¿å­˜) |
| æ˜ç´°ã®ãã®ä»– | other | âœ… OK (å„å­è¡Œã«ä¿å­˜) |

---

## ========================================
## ç¾åœ¨ã®ä¿å­˜ã‚³ãƒ¼ãƒ‰ (page.tsx 1750-1835è¡Œç›®)
## ========================================

### å€‹åˆ¥ä½œæ¥­ã®ä¿å­˜ã‚³ãƒ¼ãƒ‰
```typescript
// å€‹åˆ¥ä½œæ¥­ï¼ˆtask_type='T'ï¼‰
lineItems.push({
  invoice_id: savedInvoiceId,
  line_no: lineNo,
  sub_no: 1,
  task_type: 'T',
  target: item.target || null,
  action1: item.actions?.[0] || null,
  action2: item.actions?.[1] || null,
  action3: item.actions?.[2] || null,
  position1: item.positions?.[0] || null,
  position2: item.positions?.[1] || null,
  position3: item.positions?.[2] || null,
  position4: item.positions?.[3] || null,
  position5: item.positions?.[4] || null,
  other: item.other || null,
  raw_label: item.work_name,
  raw_label_part: item.work_name,
  unit_price: item.unit_price,
  quantity: item.quantity,
  amount: amount,
  performed_at: billingDate
})
```

### ã‚»ãƒƒãƒˆä½œæ¥­ã®ä¿å­˜ã‚³ãƒ¼ãƒ‰
```typescript
// ã‚»ãƒƒãƒˆä½œæ¥­ï¼ˆtask_type='S'ï¼‰- å„å­è¡Œã«è©³ç´°æƒ…å ±ã‚’ä¿å­˜
const detailItem = item.set_detail_items?.[index]
lineItems.push({
  invoice_id: savedInvoiceId,
  line_no: lineNo,
  sub_no: subNo,
  task_type: 'S',
  target: detailItem?.target || null,
  action1: detailItem?.actions?.[0] || null,
  action2: detailItem?.actions?.[1] || null,
  action3: detailItem?.actions?.[2] || null,
  position1: detailItem?.positions?.[0] || null,
  position2: detailItem?.positions?.[1] || null,
  position3: detailItem?.positions?.[2] || null,
  position4: detailItem?.positions?.[3] || null,
  position5: detailItem?.positions?.[4] || null,
  other: detailItem?.other || null,
  set_name: item.work_name,
  raw_label: item.set_details!.join('ã€'),
  raw_label_part: detail,
  unit_price: item.unit_price,
  quantity: item.quantity,
  amount: amount,
  performed_at: billingDate
})
```

---

## ========================================
## DBåˆ—ä¸€è¦§ (invoice_line_items)
## ========================================

- invoice_id âœ…
- line_no âœ…
- sub_no âœ…
- task_type ('T'=å€‹åˆ¥, 'S'=ã‚»ãƒƒãƒˆ) âœ…
- target âœ… (å¯¾è±¡ã®ã¿ä¿å­˜)
- action1 âœ…
- action2 âœ…
- action3 âœ…
- position1 âœ…
- position2 âœ…
- position3 âœ…
- position4 âœ…
- position5 âœ…
- other âœ…
- set_name âœ…
- raw_label âœ…
- raw_label_part âœ…
- unit_price âœ…
- quantity âœ…
- amount âœ…
- performed_at âœ…

---

## ========================================
## ä¿®æ­£å±¥æ­´
## ========================================

### 2025-12-12: å…¨é …ç›®å¯¾å¿œå®Œäº†
- WorkItemå‹ã«target, actions[], positions[], otherã‚’è¿½åŠ 
- å€‹åˆ¥ä½œæ¥­: target/action1-3/position1-5/otherã‚’DBã«ä¿å­˜
- ã‚»ãƒƒãƒˆä½œæ¥­: å„å­è¡Œã”ã¨ã«target/action1-3/position1-5/otherã‚’DBã«ä¿å­˜
- set_detail_itemsã§å„æ˜ç´°ã®è©³ç´°æƒ…å ±ã‚’ç®¡ç†
