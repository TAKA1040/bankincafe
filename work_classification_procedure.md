# 作業項目分類システム - 完全再現手順書

## 📋 概要
請求書データから抽出した作業項目を「対象・動作・位置・その他」の4分類に整理するシステムの完全手順書

## 🎯 処理目標
- **入力**: 請求書CSV（品名1～品名32カラム）
- **中間**: 分解済み作業項目（約6000件）
- **出力**: 4分類済みCSV（対象・動作・位置・その他）

## 📊 データ状況の把握
### 重要な制約
- **データ期間制限**: 使用するCSVファイルは最新2ヶ月分を含まない
- **データ更新**: 新しいデータ追加時はこの手順を再実行が必要

### データ構造
```
元データ: dada2.csv
カラム構成: 請求書番号,請求月,請求日,...,品名1,数量1,単価1,金額1,品名2,...,品名32,...
総レコード: 2312行
品名項目総数: 約3500個
分解後項目数: 約6000個
```

## 🔧 処理手順（完全版）

### ステップ1: データ分解
**目的**: 複数作業を含む品名を個別作業項目に分解

**実行内容**:
```python
# 分離文字: '・', '、', '，', ',', '　', '  ', '／', '/', '及び', 'および'
# 入力: 3500個の品名項目
# 出力: 6000個の個別作業項目
```

**出力ファイル**: `split_work_items.csv`
```
work_item,frequency
左タイヤハウスカバー脱着,15
右ドアパネル取替,12
...
```

### ステップ2: 500件バッチ分類処理
**バッチ設計**:
- バッチサイズ: 500件
- 総バッチ数: 12バッチ
- 処理順序: batch_001 → batch_012

**分類ルール**:
1. **対象（Target）**: 部品・パーツ名
   - 例: タイヤハウスカバー, ドアパネル, バンパー
2. **動作（Action）**: 作業動作
   - 例: 脱着, 取替, 修理, 調整, 交換
3. **位置（Position）**: 場所・方向
   - 例: 左, 右, 前, 後, フロント, リア
4. **その他（Other）**: 上記3つに該当しないもの

**出力フォーマット**:
```csv
作業項目,対象,動作,位置,その他,信頼度
左タイヤハウスカバー脱着,タイヤハウスカバー,脱着,左,,95%
```

### ステップ3: エラー処理・リトライ
**必須要件**: エラーバッチは必ず再処理

**処理状況管理**:
```csv
batch_processing_status.csv
バッチ番号,開始時刻,完了時刻,ステータス,処理件数,エラー詳細
001,10:00,10:05,完了,500,-
002,10:05,10:10,完了,500,-
003,10:10,-,エラー,245,メモリ不足
```

**リトライフロー**:
1. 全バッチ処理実行
2. failed_batches.txt で失敗バッチ記録
3. 全バッチ完了後、失敗分を再処理
4. 全バッチ成功まで繰り返し

## 📁 ファイル構成
```
/batch_processing/
├── split_work_items.csv                    # 6000件分解済み作業項目
├── batch_processing_status.csv             # 処理状況管理
├── failed_batches.txt                      # 失敗バッチリスト
├── batch_001_classified.csv                # バッチ1結果
├── batch_002_classified.csv                # バッチ2結果
├── ...
├── batch_012_classified.csv                # バッチ12結果
└── final_6000_classified_work_items.csv    # 最終統合結果
```

## 🔄 再実行時の手順
### 新しいデータが追加された場合
1. **新CSVファイル準備**: 最新データを含むdada2.csv更新版
2. **ステップ1再実行**: 新データでの作業項目分解
3. **件数確認**: 新しい総件数を確認（6000件→?件）
4. **バッチ数調整**: 新件数に応じてバッチ数再計算
5. **ステップ2-3実行**: 新データでの分類処理

### 既存データの再分類の場合
1. **分類ルール更新**: より精密な分類ルール適用
2. **ステップ2-3のみ実行**: 既存の6000件を新ルールで再分類

## 🛠️ 実装ファイル
- `analyze_work_items.py`: 作業項目分解処理
- `batch_classification_system.py`: 500件バッチ分類システム
- `error_handling_retry.py`: エラー処理・リトライ機能
- `final_integration.py`: バッチ結果統合処理

## 📊 期待される最終結果
- **分類済み作業項目**: 6000件（データ更新時はそれ以上）
- **対象マスター**: 清潔で体系的な部品辞書
- **動作マスター**: 標準化された作業動作辞書  
- **位置マスター**: 統一された位置情報辞書
- **品質レベル**: 100点満点中80-90点レベルの実用的な辞書

## ⚠️ 重要な注意事項
1. **データ期間**: 現在のdada2.csvは最新2ヶ月分を含まない
2. **エラー処理**: 失敗バッチは必ず再処理すること
3. **品質確認**: 各バッチ完了後は結果をサンプル確認
4. **継続性**: 新データ追加時はこの手順書に従って再実行

---
**作成日**: 2025-09-02  
**対象データ**: dada2.csv（最新2ヶ月除く）  
**次回更新時**: 最新データ追加時にこの手順で再実行