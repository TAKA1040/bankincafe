# マスター生成プロンプト v2（対象/作業/位置）

- 改訂: 既存マスターや既存候補CSVの参照・流用を明確に禁止。抽出は `raw_label_part` のみ。

既存マスターや既存候補CSVは参照せず、`invoicenew.csv` の `raw_label_part` カラムのみから新規に各マスターを自動生成するためのルール。初期 is_active は本ルールで決定する。

## 目的（今回のゴール）

- 経理・経営システムで直接活用できる、正確かつ一貫性のある「対象・作業・位置」マスターを、新規に作成する。
- 手抜きの近道（旧マスター流用や外部辞書流用）を排し、データから再構築して欠落・誤りを是正する。

## 背景：旧マスターの課題と今回の意義

- 旧マスターは以下の問題を含む可能性があるため、再構築が必要：
  - 抜け（特定の作業・対象が未登録）
  - 名寄せ不統一（例：「ドア」「ドアー」混在）
  - 位置表現の網羅不足（FR/FL と 日本語の前右/前左 の混在・欠落）
  - 主観的な追加により再現性が低い
- 今回は `raw_label_part` の事実データのみから決定ルールを定義し、誰が実行しても同じ結果になることを担保する。

## 入力と出力

- 入力
  - `C:\Windsurf\bankincafe\マスタ作成用\invoicenew.csv`
  - 使用カラム: `raw_label_part` のみ
- 出力
  - 対象: `c:/Windsurf/bankin/マスタ候補/master_target2.csv`
  - 作業: `c:/Windsurf/bankin/マスタ候補/master_action2.csv`
  - 位置: `c:/Windsurf/bankin/マスタ候補/master_position2.csv`
- 出力カラム（共通）
  - `name, name_norm, is_active, count, example`
  - `example` は最初に観測した `raw_label_part`

## 禁止事項（反・手抜きの原則）

- 既存のマスター/候補CSV（例: `マスタ/*.csv`, `マスタ候補/*.csv`）の参照・流用を禁止
- `action`, `target`, `set_name` など `raw_label_part` 以外のカラムを抽出・判定に使用しない
- 外部辞書や既存の名寄せ表の持ち込みをしない（本ドキュメントのルールのみを使用）
- 手動ホワイトリスト/ブラックリストの持ち込みをしない（必要時は本書に追記してから適用）

## 入力フィルタ（信頼できる行のみを使用）

- 以下の条件を満たす行のみをカウント対象にする：
  - `is_latest = true`
  - `is_cancelled = false`
  - `record_type != set_parent`（親の見出し行は重複源となるため除外）
  - `confidence_score >= 0.80`（閾値は運用で調整可）

## 共通前処理（正規化）

- 全角/半角: 英数字・記号は全角→半角へ統一
- カタカナ長音: 原形維持。名寄せは `name_norm` 側で吸収（例: ドアー→ドア）
- 空白/区切り: 前後空白トリム。区切りは中黒「・」に正規化（読点やスラッシュ列挙は「・」へ）
- 大小文字: ASCII は大文字へ統一（fr→FR）
- 無効トークン: 純粋な数値・単独記号は除外

## 作業マスター生成（sagyou）

- 抽出方法
  - `raw_label_part` から作業を表すキーワードを抽出
  - 作業キーワード例: 脱着、取付、取替、溶接、鈑金、塗装、調整、修正、加工、切断、張替、点検、貼付
- 集計
  - 抽出した作業キーワードでカウント
  - `example` は初出の `raw_label_part`
- name_norm（名寄せルール例）
  - 取付/取り付け/取付け → 取付
  - 取り外し/取外/取外し → 取り外し
  - 張り替え/張替え → 張替
  - 打ち替え/打替え → 打替
  - 面取/面取り → 面取り
  - 錆び止め/サビ止め → 錆止め
  - 研磨仕上げ → 仕上げ（文脈上同義と判断）
- 汎用語（誤検出リスク高）の扱い
  - 汎用語リスト: {加工, 修正, 補修, 清掃, 点検}
- is_active 初期判定
  - count ≥ 5 → true
  - 2 ≤ count ≤ 4 → name_norm が汎用語なら false、その他は true
  - count = 1 → false（レビューで昇格可）
- 並び順
  - is_active desc → count desc → name_norm asc

## 対象マスター生成（taisyou）

- 抽出方法
  - `raw_label_part` から対象部品を表すキーワードを抽出
  - 対象キーワード例: ドア、パイプ、ステー、ガード、ミラー、ハンドル、カバー、ボルト、ナット
- 集計
  - 抽出した対象キーワードでカウント
  - `example` は初出の `raw_label_part`
- name_norm（名寄せルール）
  - 長音整理: ドアー→ドア、バンパ→バンパー などプロジェクト基準で統一
  - ライト/ランプ統合（名称は「ライト」に寄せる）
    - テールライト/テールランプ → テールライト
    - バックライト/バックランプ → バックライト
    - フォグライト/フォグランプ → フォグライト
    - マーカーライト/マーカーランプ → マーカーライト
    - コーナーライト/コーナーランプ → コーナーライト
  - センサー類
    - DPF差圧センサー 等は DPFセンサー へ（必要に応じて詳細型名は保持可）
- 総称語の扱い（低精度対策）
  - 総称語リスト: {カバー, ブラケット, ステー, ボルト, ナット}
- is_active 初期判定
  - count ≥ 3 → true
  - count = 2 → name_norm が総称語のみなら false、その他は true
  - count = 1 → false。ただし以下は例外的に true
    - ライト5種（テール/バック/フォグ/マーカー/コーナー）
    - DPFセンサー
- 並び順
  - is_active desc → 種別（ライト/センサー/ボディ…）→ count desc
  - 種別は出力に含めず内部ロジックのみ

## 位置マスター生成（position）

- 抽出方法
  - `raw_label_part` から位置を表すキーワードを抽出
- 検出トークン集合（長い語優先で走査）
  - 日本語: 左, 右, 前, 後, フロント, リア, 内, 外, 上, 下, 運転席, 助手席, 前側, 後側, 中央, センター
  - 略号: FR, FL, RR, RL, LH, RH, F, R
- 検出ルール
  - 行単位にサブストリング一致で加算（同一トークンは行内1回まで）
  - 長いトークンを優先し、包含関係にある短いトークン（例: FR と F）は二重カウントしない
- name_norm（マッピング）
  - FR→前右、FL→前左、RR→後右、RL→後左
  - LH→左、RH→右
  - F→フロント、R→リア
  - 上記以外は自己マップ（例: 左→左）
- is_active 初期判定
  - count ≥ 5 → true
  - 1〜4 → true（網羅性重視）ただし count=1 の単独略号（F/R 等）は false
- 並び順
  - 論理順（前/後→左/右→内/外→上/下→席→その他）→ count desc

## 品質ゲート（出力の採用条件）

- 網羅性チェック
  - 上位頻出語で過去未登録の新語率が一定以上（例：上位100語中 新規≥10語）であること
- 一貫性チェック
  - `name` と `name_norm` の対応が一対一である（同一 `name_norm` に多数の異表記が過剰にぶら下がらない）
- ノイズ率チェック
  - is_active=false の割合が過半を超えない（抽出が広すぎる場合は閾値や辞書を見直す）
- 代表例の目視確認
  - 各マスター上位N件（例: 30件）の `example` を人間が確認し、誤検出が3件未満であること

## 監査と再現性

- すべてのルール・閾値は本ドキュメント内に記載し、コード化時も同値で実装する
- 実行ログに以下を必ず残す：
  - 入力CSVのパスとハッシュ
  - 使用したフィルタ条件と閾値
  - 出力3ファイルの件数サマリ（総件数/active件数/unique name_norm数）
- 再実行で同一結果が得られることをレビューで確認する

## 非破壊運用

- 生成先は `マスタ候補` フォルダに出力
- 既存マスターは残し、差分レポートで比較・レビュー後に採用

以上のルールで「既存に依存せず」`invoicenew.csv` の `raw_label_part` から新規マスターを生成する。スクリプト化時は、前処理→抽出/カウント→name_norm 変換→is_active 判定→並び替え→CSV 出力の順で実装する。
